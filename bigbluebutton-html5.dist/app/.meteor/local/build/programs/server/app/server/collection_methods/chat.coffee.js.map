{"version":3,"sources":["meteor://ðŸ’»app/server/collection_methods/chat.coffee"],"names":[],"mappings":"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","file":"/server/collection_methods/chat.coffee.js","sourcesContent":["Meteor.methods\n\t# meetingId: the id of the meeting\n\t# chatObject: the object including info on the chat message, including the text\n\t# requesterUserId: the userId of the user sending chat\n\t# requesterToken: the authToken of the requester\n\tsendChatMessagetoServer: (meetingId, chatObject, requesterUserId, requesterToken) ->\n\t\tchatType = chatObject.chat_type\n\t\trecipient = chatObject.to_userid\n\t\teventName = null\n\t\taction = ->\n\t\t\tif chatType is \"PUBLIC_CHAT\"\n\t\t\t\teventName = \"send_public_chat_message\"\n\t\t\t\treturn 'chatPublic'\n\t\t\telse\n\t\t\t\teventName = \"send_private_chat_message\"\n\t\t\t\tif recipient is requesterUserId\n\t\t\t\t\treturn 'chatSelf' #not allowed\n\t\t\t\telse\n\t\t\t\t\treturn 'chatPrivate'\n\n\t\tif isAllowedTo(action(), meetingId, requesterUserId, requesterToken) and chatObject.from_userid is requesterUserId\n\t\t\tchatObject.message = translateHTML5ToFlash(chatObject.message)\n\t\t\tmessage =\n\t\t\t\theader :\n\t\t\t\t\ttimestamp: new Date().getTime()\n\t\t\t\t\tname: eventName\n\t\t\t\tpayload:\n\t\t\t\t\tmessage: chatObject\n\t\t\t\t\tmeeting_id: meetingId\n\t\t\t\t\trequester_id: chatObject.from_userid\n\n\t\t\tMeteor.log.info \"publishing chat to redis\"\n\t\t\tpublish Meteor.config.redis.channels.toBBBApps.chat, message\n\t\treturn\n\n\tdeletePrivateChatMessages: (userId, contact_id) ->\n\t\t# if authorized pass through\n\t\trequester = Meteor.Users.findOne({userId: userId})\n\t\tcontact = Meteor.Users.findOne({_id: contact_id})\n\t\tdeletePrivateChatMessages(requester.userId, contact.userId)\n# --------------------------------------------------------------------------------------------\n# Private methods on server\n# --------------------------------------------------------------------------------------------\n@addChatToCollection = (meetingId, messageObject) ->\n\t# manually convert time from 1.408645053653E12 to 1408645053653 if necessary\n\t# (this is the time_from that the Flash client outputs)\n\tmessageObject.from_time = (messageObject.from_time).toString().split('.').join(\"\").split(\"E\")[0]\n\n\tif messageObject.from_userid? and messageObject.to_userid?\n\t\tmessageObject.message = translateFlashToHTML5(messageObject.message)\n\n\t\tid = Meteor.Chat.upsert({\n\t\t\tmeetingId:meetingId\n\t\t\t'message.message': messageObject.message\n\t\t\t'message.from_time': messageObject.from_time\n\t\t\t'message.from_userid': messageObject.from_userid\n\t\t\t}, {\n\t\t\tmeetingId: meetingId\n\t\t\tmessage:\n\t\t\t\tchat_type: messageObject.chat_type\n\t\t\t\tmessage: messageObject.message\n\t\t\t\tto_username: messageObject.to_username\n\t\t\t\tfrom_tz_offset: messageObject.from_tz_offset\n\t\t\t\tfrom_color: messageObject.from_color\n\t\t\t\tto_userid: messageObject.to_userid\n\t\t\t\tfrom_userid: messageObject.from_userid\n\t\t\t\tfrom_time: messageObject.from_time\n\t\t\t\tfrom_username: messageObject.from_username\n\t\t\t\tfrom_lang: messageObject.from_lang\n\t\t\t}, (err, numChanged) ->\n\t\t\t\tif err?\n\t\t\t\t\tMeteor.log.error \"_error #{err} when adding chat to collection\"\n\t\t\t\tif numChanged.insertedId?\n\t\t\t\t\tMeteor.log.info \"_added chat id=[#{numChanged.insertedId}]\n\t\t\t\t\t#{messageObject.from_username} to #{'PUBLIC' if messageObject.to_username?}:#{messageObject.message}\")\n\n# called on server start and meeting end\n@clearChatCollection = (meetingId) ->\n\tif meetingId?\n\t\tMeteor.Chat.remove({meetingId: meetingId}, Meteor.log.info \"cleared Chat Collection (meetingId: #{meetingId}!\")\n\telse\n\t\tMeteor.Chat.remove({}, Meteor.log.info \"cleared Chat Collection (all meetings)!\")\n\n# --------------------------------------------------------------------------------------------\n# end Private methods on server\n# --------------------------------------------------------------------------------------------\n\n# translate '\\n' newline character and '\\r' carriage returns to '<br/>' breakline character for Flash\n@translateHTML5ToFlash = (message) ->\n\tresult = message\n\tresult = result.replace(new RegExp(CARRIAGE_RETURN, 'g'), BREAK_LINE)\n\tresult = result.replace(new RegExp(NEW_LINE, 'g'), BREAK_LINE)\n\tresult\n\n# translate '<br/>' breakline character to '\\r' carriage return character for HTML5\n@translateFlashToHTML5 = (message) ->\n\tresult = message\n\tresult = result.replace(new RegExp(BREAK_LINE, 'g'), CARRIAGE_RETURN)\n\tresult\n"]}