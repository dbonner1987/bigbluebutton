{"version":3,"sources":["meteor://ðŸ’»app/server/redispubsub.coffee"],"names":[],"mappings":"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","file":"/server/redispubsub.coffee.js","sourcesContent":["Meteor.methods\n  # Construct and send a message to bbb-web to validate the user\n  validateAuthToken: (meetingId, userId, authToken) ->\n    Meteor.log.info \"sending a validate_auth_token with\",\n      userid: userId\n      authToken: authToken\n      meetingid: meetingId\n\n    message =\n      \"payload\":\n        \"auth_token\": authToken\n        \"userid\": userId\n        \"meeting_id\": meetingId\n      \"header\":\n        \"timestamp\": new Date().getTime()\n        \"reply_to\": meetingId + \"/\" + userId\n        \"name\": \"validate_auth_token\"\n\n    if authToken? and userId? and meetingId?\n      createDummyUser meetingId, userId, authToken\n      publish Meteor.config.redis.channels.toBBBApps.meeting, message\n    else\n      Meteor.log.info \"did not have enough information to send a validate_auth_token message\"\n\n\nclass Meteor.RedisPubSub\n  constructor: (callback) ->\n    Meteor.log.info \"constructor RedisPubSub\"\n\n    @pubClient = redis.createClient()\n    @subClient = redis.createClient()\n\n    Meteor.log.info(\"Subscribing message on channel: #{Meteor.config.redis.channels.fromBBBApps}\")\n\n    @subClient.on \"psubscribe\", Meteor.bindEnvironment(@_onSubscribe)\n    @subClient.on \"pmessage\", Meteor.bindEnvironment(@_addToQueue)\n\n    @subClient.psubscribe(Meteor.config.redis.channels.fromBBBApps)\n\n    callback @\n\n  _onSubscribe: (channel, count) =>\n    Meteor.log.info \"Subscribed to #{channel}\"\n\n    #grab data about all active meetings on the server\n    message =\n      \"header\":\n        \"name\": \"get_all_meetings_request\"\n      \"payload\": {} # I need this, otherwise bbb-apps won't recognize the message\n    publish Meteor.config.redis.channels.toBBBApps.meeting, message\n\n\n  _addToQueue: (pattern, channel, jsonMsg) =>\n    message = JSON.parse(jsonMsg)\n    eventName = message.header.name\n\n    messagesWeIgnore = [\n      \"BbbPubSubPongMessage\"\n      \"bbb_apps_is_alive_message\"\n      \"broadcast_layout_message\"\n    ]\n\n    unless eventName in messagesWeIgnore\n      console.log \"Q #{eventName} #{Meteor.myQueue.total()}\"\n      Meteor.myQueue.add({\n        pattern: pattern\n        channel: channel\n        jsonMsg: jsonMsg\n      })\n\n# --------------------------------------------------------------------------------------------\n# Private methods on server\n# --------------------------------------------------------------------------------------------\n\n# message should be an object\n@publish = (channel, message) ->\n  Meteor.log.info \"redis outgoing message  #{message.header.name}\",\n    channel: channel\n    message: message\n\n  if Meteor.redisPubSub?\n    Meteor.redisPubSub.pubClient.publish channel, JSON.stringify(message), (err, res) ->\n      if err\n        Meteor.log.info \"error\",\n          error: err\n\n  else\n    Meteor.log.info \"ERROR!! Meteor.redisPubSub was undefined\"\n"]}